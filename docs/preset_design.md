# 告知物タイプ別プリセット機能 設計書

## 1. 概要

告知物の種類や提携先に応じて、追加のチェック観点を自動適用する機能。

### 背景・課題
- 告知物は媒体や用途によって必要な確認項目が異なる
- 共同キャンペーンでは提携先固有のルールが追加される
- 追加観点を個人の記憶に頼ると、抜け漏れが発生しやすい

### 設計方針
- **既存チェックは常にON** - プリセット選択でチェックをOFFにしない（漏れ防止）
- **追加ルールの適用のみ** - タイプ/提携先を選ぶと追加観点がプロンプトに注入される
- **手動選択が基本** - 自動分類は補助扱い（誤分類リスク回避）

---

## 2. データ構造

### 2.1 プリセット定義ファイル（presets.yaml）

```yaml
# 告知物タイプ
announcement_types:
  general:
    name: "一般（指定なし）"
    rules: []

  sns_banner:
    name: "SNSバナー"
    rules:
      - "文字の見切れに注意（各SNSの表示領域を考慮）"
      - "リンク先URLまたは検索キーワードの記載を推奨"
      - "ハッシュタグ使用時は公式タグを確認"

  hp_banner:
    name: "HPバナー"
    rules:
      - "代替テキスト（alt属性）を考慮した情報設計"
      - "クリック誘導の文言が明確か確認"

  atm_screen:
    name: "ATM画面告知"
    rules:
      - "高齢者にも読みやすい文字サイズを維持"
      - "操作を促す文言は明確かつ簡潔に"
      - "画面サイズ（縦型）に適したレイアウトか確認"

  paper_flyer:
    name: "紙チラシ・ポスター"
    rules:
      - "QRコードは十分なサイズを確保（15mm以上推奨）"
      - "印刷時の色味変化を考慮（CMYK変換）"
      - "折り位置に重要情報が被らないか確認"

# 提携先プリセット
partners:
  none:
    name: "提携なし"
    rules: []

  rakuten:
    name: "楽天"
    rules:
      - "「楽天ポイント」の表記ルールを適用"
      - "楽天ロゴ使用時は提携先ガイドラインを遵守"
      - "ポイント付与条件の明記が必要"

  paypay:
    name: "PayPay"
    rules:
      - "「PayPayポイント」の正式名称を使用"
      - "PayPayロゴの使用規定を確認"
      - "キャンペーン条件の注釈を明記"

  docomo:
    name: "ドコモ（dポイント）"
    rules:
      - "「dポイント」の表記ルールを適用"
      - "dポイントクラブ会員向け条件の明記"
```

### 2.2 セッション管理

```python
# st.session_state で管理
st.session_state.selected_type = "general"      # 告知物タイプ
st.session_state.selected_partner = "none"      # 提携先
```

---

## 3. UI設計

### 3.1 配置

```
┌─────────────────────────────────────────────────────┐
│ 🏦 セブン銀行 AI校閲支援ツール                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 📤 チェック対象ファイル        ✅ チェック項目      │
│ [ファイルアップロード]         ☑ ATM画像           │
│                                ☑ ロゴ              │
│ 📄 告知物タイプ                ☑ 表記・ワーディング │
│ [一般（指定なし） ▼]           ☑ 形式             │
│                                                     │
│ 🤝 提携先                                          │
│ [提携なし ▼]                                       │
│                                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 📋 適用される追加ルール:                        │ │
│ │ ・文字の見切れに注意                            │ │
│ │ ・「楽天ポイント」の表記ルールを適用            │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│              [ 🔍 校閲を実行 ]                      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3.2 動作フロー

1. ユーザーが告知物タイプを選択
2. ユーザーが提携先を選択（任意）
3. 選択に応じた追加ルールが画面に表示される
4. 「校閲を実行」クリック
5. 追加ルールがプロンプトに注入されてAPIに送信

---

## 4. 実装設計

### 4.1 ファイル構成

```
sbk-proofread-demo/
├── rules/
│   ├── rules.yaml      # 既存の表記・形式ルール
│   └── presets.yaml    # NEW: プリセット定義
├── preset_manager.py   # NEW: プリセット読み込み・管理
├── prompt_builder.py   # 修正: 追加ルール注入対応
└── app.py              # 修正: UI追加
```

### 4.2 preset_manager.py

```python
def load_presets() -> dict:
    """presets.yaml を読み込む"""

def get_additional_rules(type_key: str, partner_key: str) -> list[str]:
    """選択されたタイプ・提携先の追加ルールを統合して返す"""
```

### 4.3 prompt_builder.py 修正

```python
def build_wording_prompt(additional_rules: list[str] = None) -> str:
    """追加ルールをプロンプトに注入"""
    # 既存のルール + additional_rules を結合
```

### 4.4 app.py 修正

```python
# プリセット選択UI
selected_type = st.selectbox("告知物タイプ", types)
selected_partner = st.selectbox("提携先", partners)

# 追加ルール表示
additional_rules = get_additional_rules(selected_type, selected_partner)
if additional_rules:
    st.info("適用される追加ルール: ...")

# プロンプト生成時に追加ルールを渡す
prompts = build_prompts_for_parallel(additional_rules=additional_rules)
```

---

## 5. 景表法リスク検知（標準機能）

### 5.1 概要

断定的な表現や最上級表現など、景表法上のリスクがある表現を検知し、「要法務確認」として出力する。

### 5.2 対象パターン（rules.yaml に追加）

```yaml
keihyo_risks:
  - id: K001
    pattern: "業界No\\.?1|ナンバーワン|No\\.?1"
    message: "最上級表現 - 根拠資料の確認が必要"

  - id: K002
    pattern: "最安|最高|最大|最小|最速"
    message: "比較広告表現 - 比較対象と根拠の明示が必要"

  - id: K003
    pattern: "絶対|必ず|100%|確実"
    message: "断定表現 - 例外がないか確認が必要"

  - id: K004
    pattern: "今だけ|期間限定|数量限定"
    message: "希少性訴求 - 実態との整合性を確認"
```

### 5.3 UI表示

結果画面で「景表法リスク」を別セクションとして強調表示。

---

## 6. 今後の拡張

### 6.1 対応可能（追加開発）
- プリセットのUI上での追加・編集機能
- 変更履歴の記録
- ユーザー別カスタムプリセット

### 6.2 要検討（別途設計が必要）
- 告知物タイプの自動判定
- 指摘カテゴリに応じた確認先の提案
